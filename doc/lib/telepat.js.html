<!DOCTYPE html>
<html>
<head>
  <title>telepat.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "projects/Telepat/javascript-sdk/lib/telepatjs", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
  <link rel="stylesheet" href="../custom.css" />
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#telepat%20javascript%20client">Telepat Javascript Client</a>
      </div>
      <div class="heading h2">
        <a href="#telepat%20object">Telepat Object</a>
      </div>
      <div class="heading h2">
        <a href="#telepat.connect">Telepat.connect</a>
      </div>
      <div class="heading h2">
        <a href="#telepat.setloglevel">Telepat.setLogLevel</a>
      </div>
      <div class="heading h2">
        <a href="#telepat.on">Telepat.on</a>
      </div>
      <div class="heading h2">
        <a href="#telepat.login">Telepat.login</a>
      </div>
      <div class="heading h2">
        <a href="#telepat.logout">Telepat.logout</a>
      </div>
      <div class="heading h2">
        <a href="#telepat.subscribe">Telepat.subscribe</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
<div class="pilwrap" id="telepat%20javascript%20client">
  <h1>
    <a href="#telepat%20javascript%20client" name="telepat%20javascript%20client" class="pilcrow">&#182;</a>
    Telepat Javascript Client
  </h1>
</div>


<p><strong>Telepat</strong> is an open-source backend stack, designed to deliver information and information updates in real-time to clients, while allowing for flexible deployment and simple scaling.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">API</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./api&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">PouchDB</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;pouchdb&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PouchDB</span><span class="p">(</span><span class="s1">&#39;_telepat&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./logger&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">EventObject</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./event&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Event</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventObject</span><span class="p">(</span><span class="nx">log</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Channel</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./channel&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="telepat%20object">
  <h2>
    <a href="#telepat%20object" name="telepat%20object" class="pilcrow">&#182;</a>
    Telepat Object
  </h2>
</div>


<p>You use the Telepat object to connect to the backend, login, subscribe and unsubscribe to channels. The object has two properties you can access:</p>

<ul>
<li><code>contexts</code>, an array of all the available contexts represented as JSON objects</li>
<li><code>subscriptions</code>, an object that holds references to <a href="http://docs.telepat.io/js-sdk.html#channel" target="_parent">Channel</a> objects, on keys named after the respective channel</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">Telepat</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">contexts</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">subscriptions</span><span class="o">:</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">apiEndpoint</span><span class="p">,</span> <span class="nx">socketEndpoint</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">ioSessionId</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">error</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">string</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">string</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">updateContexts</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">API</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;context/all&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Telepat</span><span class="p">.</span><span class="nx">contexts</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;contexts-update&#39;</span><span class="p">);</span>
    <span class="p">})</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="telepat.connect">
  <h2>
    <a href="#telepat.connect" name="telepat.connect" class="pilcrow">&#182;</a>
    Telepat.connect
  </h2>
</div>

  </div>
  <div class="body"><p>This is the first function you should call to connect to the Telepat backend. </p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Object containing all configuration options for connection</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Telepat</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">registerDevice</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">API</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;device/register&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;os&#39;</span><span class="o">:</span> <span class="s1">&#39;web&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volatile&#39;</span><span class="o">:</span> <span class="p">{</span>
          <span class="s1">&#39;type&#39;</span><span class="o">:</span> <span class="s1">&#39;sockets&#39;</span><span class="p">,</span>
          <span class="s1">&#39;token&#39;</span><span class="o">:</span> <span class="nx">ioSessionId</span><span class="p">,</span>
          <span class="s1">&#39;active&#39;</span><span class="o">:</span> <span class="mi">1</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
          <span class="nx">Event</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Device registration failed with error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">identifier</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">API</span><span class="p">.</span><span class="nx">UDID</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">identifier</span><span class="p">;</span>
            <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Received new UDID: &#39;</span> <span class="o">+</span> <span class="nx">API</span><span class="p">.</span><span class="nx">UDID</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">revision</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">newObject</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;:deviceId&#39;</span><span class="p">,</span>
              <span class="nx">value</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">identifier</span>
            <span class="p">};</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;:deviceId&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">newObject</span><span class="p">.</span><span class="nx">_rev</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span><span class="p">;</span>
              <span class="nx">log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Replacing existing UDID&#39;</span><span class="p">);</span>
              <span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">newObject</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Could not persist UDID. Error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
              <span class="p">});</span>
            <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">newObject</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Could not persist UDID. Error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
              <span class="p">});</span>
            <span class="p">});</span>
          <span class="p">}</span>
          <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Connection established&#39;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>On a successful connection, the <code>connect</code> event is emitted by the Telepat object. To listen for a connection, use:</p>


<div class="highlight"><pre><code><span class="nx">Telepat</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Connected</span>
<span class="p">});</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">Event</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">);</span>
          <span class="nx">updateContexts</span><span class="p">();</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Required configuration options:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<ul>
<li><code>apiKey</code>: the API key for the application to connect to</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">apiKey</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">API</span><span class="p">.</span><span class="nx">apiKey</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">apiKey</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Connect options must provide an apiKey property&#39;</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<ul>
<li><code>appId</code>: the id of the application to connect to</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">appId</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">API</span><span class="p">.</span><span class="nx">appId</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">appId</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Connect options must provide an appId property&#39;</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<ul>
<li><code>apiEndpoint</code>: the host and port number for the API service</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">apiEndpoint</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">apiEndpoint</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">apiEndpoint</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Connect options must provide an apiEndpoint property&#39;</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<ul>
<li><code>socketEndpoint</code>: the host and port number for the socket service</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">socketEndpoint</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socketEndpoint</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">socketEndpoint</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Connect options must provide an socketEndpoint property&#39;</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Options object not provided to the connect function&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="nx">API</span><span class="p">.</span><span class="nx">apiEndpoint</span> <span class="o">=</span> <span class="nx">apiEndpoint</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>

  <span class="nx">socket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io-client&#39;</span><span class="p">)(</span><span class="nx">socketEndpoint</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ioOptions</span> <span class="o">||</span> <span class="p">{});</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Connecting to socket service &#39;</span> <span class="o">+</span> <span class="nx">socketEndpoint</span><span class="p">);</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;welcome&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ioSessionId</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">;</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Got session ID &#39;</span> <span class="o">+</span> <span class="nx">ioSessionId</span><span class="p">);</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;:deviceId&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">API</span><span class="p">.</span><span class="nx">UDID</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Retrieved saved UDID: &#39;</span> <span class="o">+</span> <span class="nx">UDID</span><span class="p">);</span>
      <span class="nx">registerDevice</span><span class="p">();</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">registerDevice</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">processOperation</span><span class="p">(</span><span class="nx">operation</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">Telepat</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">operation</span><span class="p">.</span><span class="nx">subscription</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="nx">Telepat</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">[</span><span class="nx">operation</span><span class="p">.</span><span class="nx">subscription</span><span class="p">];</span>
        <span class="nx">channel</span><span class="p">.</span><span class="nx">processPatch</span><span class="p">(</span><span class="nx">operation</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Event</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Received update on non-existent subscription&#39;</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">log</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;Received update: &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="k">new</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">operation</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="k">new</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">processOperation</span><span class="p">(</span><span class="nx">operation</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">updated</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">operation</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">updated</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">processOperation</span><span class="p">(</span><span class="nx">operation</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">deleted</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">operation</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">deleted</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">processOperation</span><span class="p">(</span><span class="nx">operation</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;context-update&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">updateContexts</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">Event</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="telepat.setloglevel">
  <h2>
    <a href="#telepat.setloglevel" name="telepat.setloglevel" class="pilcrow">&#182;</a>
    Telepat.setLogLevel
  </h2>
</div>

  </div>
  <div class="body"><p>You can tweak the logger verbosity using this function.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">level</span>
      <span class="dox_type">string</span>
      <span>One of <code>'debug'</code>, <code>'info'</code>, <code>'warn'</code> or <code>'error'</code></span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Telepat</span><span class="p">.</span><span class="nx">setLogLevel</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">setLevel</span><span class="p">(</span><span class="nx">level</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="telepat.on">
  <h2>
    <a href="#telepat.on" name="telepat.on" class="pilcrow">&#182;</a>
    Telepat.on
  </h2>
</div>

  </div>
  <div class="body"><p>Call this function to add callbacks to be invoked on event triggers.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">name</span>
      <span class="dox_type">string</span>
      <span>The name of the event to associate the callback with</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">callback</span>
      <span class="dox_type">function</span>
      <span>The callback to be executed</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Telepat</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Event</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="telepat.login">
  <h2>
    <a href="#telepat.login" name="telepat.login" class="pilcrow">&#182;</a>
    Telepat.login
  </h2>
</div>

  </div>
  <div class="body"><p>This function associates the current anonymous device to a Telepat user profile.</p>

<p>Two events can be asynchronously triggered by this function:</p>

<ul>
<li><code>login</code>, on success</li>
<li><code>login_error</code>, on error</li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">facebookToken</span>
      <span class="dox_type">string</span>
      <span>The user token obtained from Facebook after login</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Telepat</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">facebookToken</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">API</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;user/login&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">access_token</span><span class="o">:</span> <span class="nx">facebookToken</span>
  <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;login_error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Login failed with error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">API</span><span class="p">.</span><span class="nx">authenticationToken</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="telepat.logout">
  <h2>
    <a href="#telepat.logout" name="telepat.logout" class="pilcrow">&#182;</a>
    Telepat.logout
  </h2>
</div>

  </div>
  <div class="body"><p>Obviously, logs a user out.
Two events can be asynchronously triggered by this function:</p>

<ul>
<li><code>logout</code>, on success</li>
<li><code>logout_error</code>, on error</li>
</ul>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Telepat</span><span class="p">.</span><span class="nx">logout</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">API</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;user/logout&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;logout_error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Logout failed with error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">API</span><span class="p">.</span><span class="nx">authenticationToken</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">Event</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;logout&#39;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="telepat.subscribe">
  <h2>
    <a href="#telepat.subscribe" name="telepat.subscribe" class="pilcrow">&#182;</a>
    Telepat.subscribe
  </h2>
</div>

  </div>
  <div class="body"><p>Use this function to create a new <a href="http://docs.telepat.io/js-sdk.html#channel" target="_parent">Channel</a> object and connect it to the backend.</p>

<p>You can pass a callback to be invoked on channel subscription. This is equivalent to calling <code>.on('subscribe' ...)</code> directly on the returned Channel.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">contextId</span>
      <span class="dox_type">integer</span>
      <span>The id of the context to subscribe to</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">channelId</span>
      <span class="dox_type">string</span>
      <span>The id of the channel to subscribe to</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">onSubscribe</span>
      <span class="dox_type">function</span>
      <span class="dox_type">optional</span>
      <span>Callback to be executed on a successful subscribe</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Channel</span>
      <span>The new <a href="http://docs.telepat.io/js-sdk.html#channel" target="_parent">Channel</a> object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">Telepat</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">contextId</span><span class="p">,</span> <span class="nx">channelId</span><span class="p">,</span> <span class="nx">onSubscribe</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Channel</span><span class="p">(</span><span class="nx">API</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">contextId</span><span class="p">,</span> <span class="nx">channelId</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;blg:&#39;</span><span class="o">+</span><span class="nx">contextId</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nx">channelId</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">;</span>
  <span class="nx">channel</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">onSubscribe</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="nx">onSubscribe</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">channel</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;_unsubscribe&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">channel</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Telepat</span><span class="p">;</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
