<!DOCTYPE html>
<html>
  <head>
    <script src="../dist/telepat.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  </head>
  <body>
  <script>
    function statusChangeCallback(response) {
      if (response.status === 'connected') {
        Telepat.login(response.authResponse.accessToken);
      } else if (response.status === 'not_authorized') {
        document.getElementById('status').innerHTML = 'Please log into this app.';
      } else {
        document.getElementById('status').innerHTML = 'Please log into Facebook.';
      }
    }

    function checkLoginState() {
      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });
    }

    function addObject() {
      eventChannel.objects['new'] = {
        text: 'Hello world'
      };
    }

    function removeObject(id) {
      delete eventChannel.objects[id];
    }

    function editObject(id) {
      eventChannel.objects[id].text = $('#' + id + '_input').val();
    }

    function appendToList(key, value) {
      $('#list').append('<div style="padding:5px; border-bottom:1px solid" id="' + key + '">' + key + ': <input type="text" id="' + key + '_input" value="' + value.text + '" onkeyup="editObject(\'' + key + '\');"> <span id="' + key + '_span">' + value.text + '</span><div style="float:right"><a href="#" onclick="removeObject(\'' + key + '\'); return false;">Delete</a></div></div>');
    }

    function subscribe() {
      eventChannel = Telepat.subscribe(Object.keys(Telepat.contexts)[0], 'events', function () {
        $('#list').empty();
        $.each(eventChannel.objects, function (key, value) {
          appendToList(key, value);
        });
      });
      eventChannel.on('update', function (operation, parentId, parentObject, delta) {
        console.log(operation, parentId, parentObject, delta);
        if (operation == 'delete') {
          $('#' + parentId).remove();
        } else if (operation == 'add') {
          appendToList(parentId, parentObject);
        } else if (operation == 'replace') {
          $('#' + parentId + '_span').text(parentObject[delta.path]);
          //$('#status').append('<div>' + parentObject[delta.path] + '</div>');
        }
      });
      eventChannel.on('unsubscribe', function () {
        $('#list').empty();
      });
    }

    var eventChannel;
    window.fbAsyncInit = function() {
        FB.init({
          appId      : '1086083914753251',
          xfbml      : true,
          version    : 'v2.3',
          status     : true
        });

        Telepat.setLogLevel('debug');

        Telepat.on('login', function () {
          console.log("logged in");
          subscribe();
        });

        Telepat.on('logout', function () {
          console.log("logged out");
          $('#list').empty();
        })

        Telepat.on('connect', function () {
          checkLoginState();
        });

        Telepat.on('contexts-update', function () {
          //Telepat.subscribe(Object.keys(Telepat.contexts)[0], 'event');
        });

        Telepat.connect({
          apiKey: '3406870085495689e34d878f09faf52c',
          appId: 1,
          apiEndpoint: 'http://blg-octopus-api.cloudapp.net:3000',
          socketEndpoint: 'http://blg-octopus-api.cloudapp.net'
        });
      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "//connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
  </script>

  <div style="float:left">
    <fb:login-button scope="public_profile,email,user_about_me,user_friends" onlogin="checkLoginState();">
    </fb:login-button>
    <br/>
    <button onclick="Telepat.logout()">Logout</button>
    <br/>
    <button onclick="subscribe()">Subscribe</button>
    <br/>
    <button onclick="eventChannel.unsubscribe()">Unsubscribe</button>
    <br/>
    <button onclick="addObject()">Add Object</button>

    <div id="status">
    </div>
  </div>
  <div id="list" style="margin-left: 200px">
    
  </div>
  </body>
</html>